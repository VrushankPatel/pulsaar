name: CI/CD

permissions:
  contents: read

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - master

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v6
        with:
           go-version: '1.25.5'
      - run: go test -coverprofile=coverage.out ./...
      - uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          fail_ci_if_error: false
      - uses: golangci/golangci-lint-action@v9
        with:
          version: latest
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
      - name: Run govulncheck
        run: govulncheck ./...

  build-binaries:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v6
        with:
           go-version: '1.25.5'
      - run: |
          mkdir -p bin
          go build -o bin/agent ./cmd/agent
          go build -o bin/aggregator ./cmd/aggregator
          go build -o bin/cli ./cmd/cli
          go build -o bin/webhook ./cmd/webhook
      - uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/

  deploy-test:
    needs: build-binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v6
        with:
           go-version: '1.25.5'
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: bin/
      - run: chmod +x bin/*
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/
      - name: Install Helm
        run: |
          curl https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz -o helm.tar.gz
          tar -zxvf helm.tar.gz
          sudo mv linux-amd64/helm /usr/local/bin/helm
      - name: Create kind cluster
        run: kind create cluster --name pulsaar-test
      - name: Install Helm chart
        run: |
          helm install pulsaar-test ./charts/pulsaar --set agent.image.tag=latest --set aggregator.image.tag=latest --set webhook.image.tag=latest
      - name: Wait for deployments
        run: kubectl wait --for=condition=available --timeout=300s deployment/pulsaar-agent deployment/pulsaar-aggregator deployment/pulsaar-webhook
      - name: Run deployment test
        run: ./scripts/test_deployment.sh local

  build-images:
    needs: [build-binaries, deploy-test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: startsWith(github.ref, 'refs/tags/')
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Extract tag
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
      - run: |
          docker build -f Dockerfile.agent -t vrushankpatel/pulsaar-agent:latest .
          docker build -f Dockerfile.aggregator -t vrushankpatel/pulsaar-aggregator:latest .
          docker build -f Dockerfile.cli -t vrushankpatel/pulsaar-cli:latest .
          docker build -f Dockerfile.webhook -t vrushankpatel/pulsaar-webhook:latest .
          if [ -n "$TAG" ]; then
            docker tag vrushankpatel/pulsaar-agent:latest vrushankpatel/pulsaar-agent:$TAG
            docker tag vrushankpatel/pulsaar-aggregator:latest vrushankpatel/pulsaar-aggregator:$TAG
            docker tag vrushankpatel/pulsaar-cli:latest vrushankpatel/pulsaar-cli:$TAG
            docker tag vrushankpatel/pulsaar-webhook:latest vrushankpatel/pulsaar-webhook:$TAG
            docker push vrushankpatel/pulsaar-agent:$TAG
            docker push vrushankpatel/pulsaar-aggregator:$TAG
            docker push vrushankpatel/pulsaar-cli:$TAG
            docker push vrushankpatel/pulsaar-webhook:$TAG
          fi

  release:
    needs: [test, build-binaries]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v6
        with:
           go-version: '1.25.5'
      - name: Import GPG key
        run: echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --import --batch
      - name: Set GPG fingerprint
        run: 'echo "GPG_FINGERPRINT=$(gpg --list-keys --with-colons | awk -F: \"/^pub:/ { print \$5; exit }\")" >> $GITHUB_ENV'
      - uses: goreleaser/goreleaser-action@v5
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_FINGERPRINT: ${{ env.GPG_FINGERPRINT }}